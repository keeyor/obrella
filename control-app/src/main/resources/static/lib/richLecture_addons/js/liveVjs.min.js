const crossDomain_option=!1;let info,actions;cuepointsx=[],slide_at=[],slide_titles=[];let ajaxRefreshInterval,vid_lecture_id,hls,hls_sec,video_url_primary="",video_url_ipcamera="",video_url_camcast="",video_url_screencast="",secondary_resource="",basepath="",number_of_total_slides=0,webRoot="",presentation_file="",slides_file="",slides_loaded=0,isPlaying=!1,isSecPlaying=!1;function getOpenDelosLiveSlide(e){var t=$("#slide_container");let s=$("#resources_base_url").val();$.ajax({url:webRoot+"/services/api/v1/resource/slide_exists?filename=currentSlide.jpg&resourceId="+e,type:"get",error:function(e){},success:function(i){"1"===i?$(t).attr("src",s+"/_Repo/"+e+"/slides/currentSlide.jpg?t="+(new Date).getTime()):$(t).attr("src",webRoot+"/resources/images/deloslogo.png")}})}function startLiveSlidesBroadcast(e){ajaxRefreshInterval=setInterval(function(){getOpenDelosLiveSlide(e)},2e3)}function stopLiveSlidesBroadcast(){clearInterval(ajaxRefreshInterval)}function read_parameters_XML(){let e=$("#time_left_badge");$.ajax({type:"GET",url:presentation_file,dataType:"xml",crossDomain:crossDomain_option,cache:!1,success:function(t){let s=$(t).find("real_duration").text();var i;i="event:"!==$(t).find("header").text().substring(0,6)?setInterval(function(){(s-=1)<=0?(clearInterval(i),StopLiveFeed(),this.stopLiveSlidesBroadcast(),e.html(Seconds2HHMMSS(s))):e.html(Seconds2HHMMSS(s))},1e3):setInterval(function(){(s-=1)<=0?$.ajax({type:"GET",url:presentation_file,dataType:"xml",crossDomain:crossDomain_option,cache:!1,success:function(t){(s=$(t).find("real_duration").text())<=0&&(clearInterval(i),StopLiveFeed(),this.stopLiveSlidesBroadcast(),e.html(Seconds2HHMMSS(s)))}}):e.html(Seconds2HHMMSS(s))},1e3);let a=$(t).find("logo").text(),r=reformat_datetime($(t).find("date").text()),l=$(t).find("serie").text(),o=$(t).find("duration").text(),n=$(t).find("description:first").text(),c=$(t).find("header").text(),d=$(t).find("slide"),u=($(t).find("live_slides"),$(t).find("presenter").text());video_url_ipcamera=$(t).find("resource[format=ipcamera]").text(),video_url_camcast=$(t).find("resource[format=camcast]").text(),$(document).attr("title",l),$(".header-item").text(l+" | "+r),$(".header-logo").html('<img class="header-logo" alt="Institution logo" src="'+a+'"/>'),video_url_primary="-1"===video_url_ipcamera?video_url_camcast:video_url_ipcamera,video_url_screencast=$(t).find("resource[format=screencast]").text(),secondary_resource="live_slides"===video_url_screencast?"live_slides":d.length?"slides":"-1"!==video_url_screencast?"screencast":"none";$("#primary_video_panel");"slides"!==secondary_resource&&$("#myCarousel").remove(),"screencast"!==secondary_resource&&$("#secondary_video_container").remove();let _=$(".aside-1"),p=$("#player");"none"===secondary_resource&&($(".aside-2").css("flex","0 0 0"),_.css("flex","3 1"),p.removeClass("w-100"),p.css("margin","0 auto"),_.css("align-items","center"),_.css("justify-content","center")),"live_slides"!==secondary_resource?$("#live_slides_panel").remove():startLiveSlidesBroadcast(vid_lecture_id),"event:"===c.substring(0,6)&&(c=c.substring(6,c.length),$("#lecture_department").html(language.p1+"<span></span>"),$("#lecture_serie").html(language.p2+"<span></span>")),$("#lecture_date span").html(r),$("#lecture_duration span").html(o),$("#lecture_description span").html(n),$("#lecture_department span").html(c),$("#lecture_serie span").html(l),-1===u?$("#lecture_presenter").remove():$("#lecture_presenter span").html(u)},complete:function(){-1!==video_url_primary.indexOf("camcast")?($("#buttonGo").show(),load_player_primary(video_url_primary)):($("#buttonGo").hide(),load_player_primary()),"slides"===secondary_resource?read_slides_XML():"screencast"===secondary_resource?load_secondary_player():slides_loaded=1}})}function load_player_primary(e){let t,s=video_url_primary;void 0!==e&&(s+="_720p/playlist.m3u8"),console.log("Primary Video Source:"+s);try{hls.destroy()}catch(e){}Hls.isSupported()&&(t=document.getElementById("player"),Hls.isSupported()?((hls=new Hls).loadSource(s),hls.attachMedia(t),hls.on(Hls.Events.MANIFEST_PARSED,function(){console.log("manifest loaded, found "+data.levels.length+" quality level"),t.play(),isPlaying=!0}),hls.on(Hls.Events.ERROR,function(e,t){if(t.fatal){let e=$("#sdpDataTag");switch(t.type){case Hls.ErrorTypes.NETWORK_ERROR:console.log("fatal network error encountered, try to recover"),e.html("<small>fatal network error encountered, trying to recover</small>"),hls.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.log("fatal media error encountered, try to recover"),e.html("<small>fatal media error encountered, trying to recover</small>"),hls.recoverMediaError();break;default:hls.destroy(),StopLiveFeed(),this.stopLiveSlidesBroadcast()}}})):t.canPlayType("application/vnd.apple.mpegurl")&&(console.log("Sec option"),t.src=s,t.addEventListener("loadedmetadata",function(){t.play(),isPlaying=!0})))}function load_secondary_player(){let e,t=video_url_screencast;console.log("Secondary Video Source:"+t),Hls.isSupported()&&(e=document.getElementById("sec_player"),Hls.isSupported()?((hls_sec=new Hls).loadSource(t),hls_sec.attachMedia(e),hls_sec.on(Hls.Events.MANIFEST_PARSED,function(){console.log("sec manifest loaded, found "+data.levels.length+" quality level"),e.play(),isSecPlaying=!0}),hls_sec.on(Hls.Events.ERROR,function(e,t){if(t.fatal)switch(t.type){case Hls.ErrorTypes.NETWORK_ERROR:console.log("sec fatal network error encountered, try to recover"),hls_sec.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.log("sec fatal media error encountered, try to recover"),hls_sec.recoverMediaError();break;default:hls_sec.destroy(),StopSecLiveFeed()}})):e.canPlayType("application/vnd.apple.mpegurl")&&(console.log("Sec option"),e.src=t,e.addEventListener("loadedmetadata",function(){e.play(),isSecPlaying=!0})))}function read_slides_XML(){let e=0;$.ajax({type:"GET",url:slides_file,crossDomain:crossDomain_option,dataType:"xml",cache:!1,success:function(t){for(basepath=$(t).find("basepath").text(),$(t).find("slide").each(function(){var t=$(this).find("url").text();t=basepath+t;var s=$(this).find("title").text();s.length||(s=language.s4),cuepointsx.push(1e3*e),slide_at[1e3*e]=t,slide_titles[1e3*e]=s,e++}),j=0;j<cuepointsx.length;j++){var s=slide_at[cuepointsx[j]].lastIndexOf("/");let e=slide_at[cuepointsx[j]].substr(0,s+1)+"small/"+slide_at[cuepointsx[j]].substr(s+1),t="carousel-item";0===j&&(t="carousel-item active");let i='<img src="'+slide_at[1e3*j]+'" title="'+(j+1)+". "+slide_titles[cuepointsx[j]]+'"   alt="">';$('<div class="'+t+'" data-slide-number="'+j+'"></div>').html(i).appendTo($(".carousel-inner"));let a='<figure class="figure" style="font-size: smaller;font-weight: normal;margin:0"><img class="img-thumbnail img-fluid" src="'+e+'" title="'+(j+1)+". "+slide_titles[cuepointsx[j]]+'" style="max-width: 100%;min-width:100px;height: auto"  alt=""/><figcaption class="figure-caption">no.'+(j+1)+"</figcaption></figure> </a>",r="list-inline-item";0===j&&(a='<a id="carousel-selector-'+j+'">'+a+"</a>",r="list-inline-item active"),$('<li class="'+r+'" data-slide-to="'+j+'" data-target="#myCarousel">'+a+"</li>").appendTo($(".carousel-indicators"))}number_of_total_slides=e,scroll_area_img_height=0,slides_loaded=1}})}function getRootWebSitePath(){var e=document.location.toString(),t=e.indexOf("/",e.indexOf("://")+3),s=e.substring(0,t)+"/",i=e.indexOf("/",e.indexOf(s)+s.length);return e.substring(0,i)}function Seconds2HHMMSS(e){let t=parseInt(e,10),s=Math.floor(t/3600),i=Math.floor((t-3600*s)/60),a=t-3600*s-60*i;return s<10&&(s="0"+s),i<10&&(i="0"+i),a<10&&(a="0"+a),s+":"+i+":"+a}function reformat_datetime(e){let t=e.split(" "),s=t[0].split("-");return s[2]+"-"+s[1]+"-"+s[0]+" "+t[1]}function StopLiveFeed(){-1===video_url_primary.indexOf("camcast")&&hls.destroy(),$("#player").remove(),$("#info_button").remove();let e='<img id="stream_ended" alt="The live stream has finished" src="'+webRoot+"/resources/richLecture_addons/css/images_player/live_ended-"+language.selectedLang+'.jpg"/>';$('<div style="border: #0b6da8 1px solid;width: 603px;height: 341px;display: block;margin:0 auto 0 auto"></div>').html(e).prependTo($("#primary_video_container")),$("#buttonGo").hide(),console.log("feed ended")}function StopSecLiveFeed(){-1===video_url_primary.indexOf("camcast")&&hls_sec.destroy(),$("#sec_player").remove();let e='<img id="stream_ended" alt="The live stream has finished" src="'+webRoot+"/resources/richLecture_addons/css/images_player/live_ended-"+language.selectedLang+'.jpg"/>';$('<div style="border: #0b6da8 1px solid;width: 603px;height: 341px;display: block;margin:0 auto 0 auto"></div>').html(e).prependTo($("#secondary_video_container")),console.log("feed ended")}function getLiveStreamConnections(e,t){jQuery.support.cors=!0;let s=webRoot+"/services/wowza/room/"+e+"/stream/"+t+"/streamLiveConnections";$.ajax({type:"GET",url:s,contentType:"application/json; charset=utf-8",dataType:"json",crossDomain:!0,success:function(e){$("#viewers_badge").html(e.totalConnections)},error:function(){$("#viewers_badge").html("!")}})}$(document).ready(function(){webRoot=getRootWebSitePath(),presentation_file=webRoot+"/scheduler/service/presentation/",slides_file=webRoot+"/scheduler/service/slides/",vid_lecture_id=window.location.search.replace("?id=",""),presentation_file+=vid_lecture_id,slides_file+=vid_lecture_id,read_parameters_XML(),$(".carousel").carousel({interval:!1}),$(".carousel-indicators").on("click",".list-inline-item",function(){$(".list-inline-item").removeClass("active"),$(this).addClass("active")}),$(".carousel-control-next").on("click",function(){let e=$(".carousel-item.active");$(".list-inline-item").removeClass("active");let t=e.data("slide-number")+1;t>$(".carousel-indicators li").length-1&&(t=0);let s=$(".carousel-indicators li:nth-child("+(t+1)+")");s.addClass("active"),s.focus();let i=$(".img-thumbnail").first().width();$(".carousel-indicators").scrollLeft(t*i)}),$(".carousel-control-prev").on("click",function(){let e=$(".carousel-item.active");$(".list-inline-item").removeClass("active");let t=e.data("slide-number")-1,s=$(".carousel-indicators li").length;t<0&&(t=s-1);let i=$(".carousel-indicators li:nth-child("+(t+1)+")");i.addClass("active"),i.focus();let a=$(".img-thumbnail").first().width();$(".carousel-indicators").scrollLeft(t*a)});let e=$("#roomCode").val(),t=$("#streamfile").val(),s=setInterval(function(){getLiveStreamConnections(e,t)},1e4);""!==e&&""!==t||clearInterval(s)});